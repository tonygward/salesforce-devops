name: Deploy to Salesforce

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: CI/CD Scripts
        run: find ./scripts/cicd -type f -exec chmod u+x {} +

      - name: Install Salesforce CLI
        run: npm install --global @salesforce/cli

      - name: Authenticate to Salesforce
        run: |
          echo "${{ secrets.GMAIL_AUTH_URL }}" > auth.txt
          sf auth sfdxurl store --sfdx-url-file auth.txt --alias gmail
          sf config set target-org=gmail

      - name: Deploy
        run: sf project deploy start --source-dir force-app --wait 10

      - name: Test Apex
        run: |
          testRunCode=0
          sf apex run test \
            --test-level RunLocalTests \
            --output-dir test-results \
            --code-coverage \
            --detailed-coverage \
            --wait 10 || testRunCode=$?

          cat test-results/test-result.txt
          testRunId=$(cat test-results/test-run-id.txt)
          testResultsFileName="test-results/test-result-$testRunId.json"
          echo $testResultsFileName

          exit "$testRunCode" # Stop if tests failed

          ./scripts/cicd/check-class-coverage.sh

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: apex-test-artifacts
          path: |
            test-results/**
            coverage/**